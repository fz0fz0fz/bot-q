from flask import Flask, request, jsonify
import requests

app = Flask(__name__)

# Ø±Ù‚Ù…Ùƒ Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
YOUR_PHONE_NUMBER = "966503813344"

# Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¤Ù‚ØªØ§Ù‹ (Ø°Ø§ÙƒØ±Ø© Ù…Ø¤Ù‚ØªØ© ÙÙ‚Ø·)
user_states = {}
user_data = {}

# Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø´Ø±Ù
def send_to_admin(message):
    try:
        requests.post("https://api.wasender.io/sendMessage", json={
            "to": YOUR_PHONE_NUMBER,
            "message": message
        })
    except Exception as e:
        print("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø´Ø±Ù:", e)

# Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
PROCESS_MAP = {
    "55": "add_worker",
    "88": "add_driver",
    "77": "add_shop",
    "90": "add_rent"
}

def is_valid_phone(phone):
    # ØªØ­Ù‚Ù‚ Ø¨Ø³ÙŠØ· Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ
    return phone.isdigit() and (len(phone) == 9 or (len(phone) == 10 and phone.startswith('0')))

@app.route("/webhook", methods=["POST"])
def webhook():
    data = request.json
    user_id = data.get("from")
    message = data.get("message", "").strip()

    # Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if user_id not in user_states:
        user_states[user_id] = None
        user_data[user_id] = {}

    # Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø¹Ù…Ù„ÙŠØ©ØŒ Ù†Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
    if user_states[user_id] is None:
        if message in PROCESS_MAP:
            user_states[user_id] = PROCESS_MAP[message]
            user_data[user_id] = {}
            # Ø§Ù„Ø±Ø¯ Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            if message == "55":
                reply = "Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„:"
            elif message == "88":
                reply = "Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚:"
            elif message == "77":
                reply = "Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„:"
            elif message == "90":
                reply = "Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ù„Ù„ØªØ£Ø¬ÙŠØ±:"
            return jsonify({"reply": reply})

        # Ø£ÙŠ Ø±Ø³Ø§Ù„Ø© Ø£Ø®Ø±Ù‰ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø®ØµØµØ©
        return jsonify({"reply": "Ù…Ø±Ø­Ø¨Ù‹Ø§! Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:\n55 Ù„Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„\n88 Ù„Ø¥Ø¶Ø§ÙØ© Ø³Ø§Ø¦Ù‚\n77 Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ù„\n90 Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ø¶Ø§Ø¹Ø© Ù„Ù„ØªØ£Ø¬ÙŠØ±"}), 200

    # Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø¹Ù…Ù„ÙŠØ©
    process = user_states[user_id]

    # Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„
    if process == "add_worker":
        if "name" not in user_data[user_id]:
            user_data[user_id]["name"] = message
            return jsonify({"reply": "Ø£Ø¯Ø®Ù„ Ù…Ù‡Ù†Ø© Ø§Ù„Ø¹Ø§Ù…Ù„:"})
        elif "job" not in user_data[user_id]:
            user_data[user_id]["job"] = message
            return jsonify({"reply": "Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø§Ù…Ù„ (Ø¨Ø¯ÙˆÙ† Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø©):"})
        elif "phone" not in user_data[user_id]:
            if not is_valid_phone(message):
                return jsonify({"reply": "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„Ù‡ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ (Ù…Ø«Ø§Ù„: 501234567 Ø£Ùˆ 0501234567)"})
            user_data[user_id]["phone"] = message
            info = f"Ø·Ù„Ø¨ Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„ Ø¬Ø¯ÙŠØ¯:\nØ§Ù„Ø§Ø³Ù…: {user_data[user_id]['name']}\nØ§Ù„Ù…Ù‡Ù†Ø©: {user_data[user_id]['job']}\nØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: {user_data[user_id]['phone']}"
            send_to_admin(info)
            user_states[user_id] = None
            user_data[user_id] = {}
            return jsonify({"reply": "ØªÙ… Ø­ÙØ¸ Ø·Ù„Ø¨Ùƒ ÙˆØ§Ø±Ø³Ø§Ù„Ù‡ Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù„Ù…Ø´Ø±Ù Ù„Ø¥Ø¶Ø§ÙØªÙ‡ ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª Ù…Ù…ÙƒÙ†ØŒ Ø´ÙƒØ±Ø§ Ù„Ùƒ ğŸ™"})

    # Ø¥Ø¶Ø§ÙØ© Ø³Ø§Ø¦Ù‚
    elif process == "add_driver":
        if "name" not in user_data[user_id]:
            user_data[user_id]["name"] = message
            return jsonify({"reply": "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© (Ù†Ù‚Ù„ Ù…Ø¯Ø±Ø³ÙŠØŒ Ù…Ø´Ø§ÙˆÙŠØ±ØŒ ØªÙˆØµÙŠÙ„ Ø·Ù„Ø¨Ø§Øª):"})
        elif "services" not in user_data[user_id]:
            user_data[user_id]["services"] = message
            return jsonify({"reply": "Ø£Ø¯Ø®Ù„ ÙˆØµÙ ÙˆØ´Ø±ÙˆØ· Ø§Ù„Ø®Ø¯Ù…Ø© (Ù…Ø«Ù„Ø§Ù‹: Ù†Ù‚Ù„ Ù…Ù† ÙƒØ°Ø§ Ø¥Ù„Ù‰ ÙƒØ°Ø§):"})
        elif "details" not in user_data[user_id]:
            user_data[user_id]["details"] = message
            return jsonify({"reply": "Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ (Ø¨Ø¯ÙˆÙ† Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø©):"})
        elif "phone" not in user_data[user_id]:
            if not is_valid_phone(message):
                return jsonify({"reply": "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„Ù‡ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ (Ù…Ø«Ø§Ù„: 501234567 Ø£Ùˆ 0501234567)"})
            user_data[user_id]["phone"] = message
            info = f"Ø·Ù„Ø¨ Ø¥Ø¶Ø§ÙØ© Ø³Ø§Ø¦Ù‚ Ø¬Ø¯ÙŠØ¯:\nØ§Ù„Ø§Ø³Ù…: {user_data[user_id]['name']}\nØ§Ù„Ø®Ø¯Ù…Ø§Øª: {user_data[user_id]['services']}\nØ§Ù„ØªÙØ§ØµÙŠÙ„: {user_data[user_id]['details']}\nØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: {user_data[user_id]['phone']}"
            send_to_admin(info)
            user_states[user_id] = None
            user_data[user_id] = {}
            return jsonify({"reply": "ØªÙ… Ø­ÙØ¸ Ø·Ù„Ø¨Ùƒ ÙˆØ§Ø±Ø³Ø§Ù„Ù‡ Ù„Ù„Ù…Ø´Ø±Ù Ù„Ø¥Ø¶Ø§ÙØªÙ‡ ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª Ù…Ù…ÙƒÙ†ØŒ Ø´ÙƒØ±Ø§ Ù„Ùƒ ğŸ™"})

    # Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ù„
    elif process == "add_shop":
        if "name" not in user_data[user_id]:
            user_data[user_id]["name"] = message
            return jsonify({"reply": "Ø£Ø¯Ø®Ù„ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­Ù„:"})
        elif "type" not in user_data[user_id]:
            user_data[user_id]["type"] = message
            return jsonify({"reply": "Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø­Ù„ (Ø¨Ø¯ÙˆÙ† Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø©):"})
        elif "phone" not in user_data[user_id]:
            if not is_valid_phone(message):
                return jsonify({"reply": "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„Ù‡ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ (Ù…Ø«Ø§Ù„: 501234567 Ø£Ùˆ 0501234567)"})
            user_data[user_id]["phone"] = message
            info = f"Ø·Ù„Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ù„ Ø¬Ø¯ÙŠØ¯:\nØ§Ù„Ø§Ø³Ù…: {user_data[user_id]['name']}\nØ§Ù„Ù†ÙˆØ¹: {user_data[user_id]['type']}\nØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: {user_data[user_id]['phone']}"
            send_to_admin(info)
            user_states[user_id] = None
            user_data[user_id] = {}
            return jsonify({"reply": "ØªÙ… Ø­ÙØ¸ Ø·Ù„Ø¨Ùƒ ÙˆØ§Ø±Ø³Ø§Ù„Ù‡ Ù„Ù„Ù…Ø´Ø±Ù Ù„Ø¥Ø¶Ø§ÙØªÙ‡ ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª Ù…Ù…ÙƒÙ†ØŒ Ø´ÙƒØ±Ø§ Ù„Ùƒ ğŸ™"})

    # Ø¥Ø¶Ø§ÙØ© Ø¨Ø¶Ø§Ø¹Ø© ØªØ£Ø¬ÙŠØ±
    elif process == "add_rent":
        if "item" not in user_data[user_id]:
            user_data[user_id]["item"] = message
            return jsonify({"reply": "Ø£Ø¯Ø®Ù„ ÙˆØµÙ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© ÙˆØ§Ù„Ø´Ø±ÙˆØ·:"})
        elif "details" not in user_data[user_id]:
            user_data[user_id]["details"] = message
            return jsonify({"reply": "Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ (Ø¨Ø¯ÙˆÙ† Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø©):"})
        elif "phone" not in user_data[user_id]:
            if not is_valid_phone(message):
                return jsonify({"reply": "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„Ù‡ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ (Ù…Ø«Ø§Ù„: 501234567 Ø£Ùˆ 0501234567)"})
            user_data[user_id]["phone"] = message
            info = f"Ø·Ù„Ø¨ Ø¥Ø¶Ø§ÙØ© Ø¨Ø¶Ø§Ø¹Ø© Ù„Ù„ØªØ£Ø¬ÙŠØ±:\nØ§Ù„Ø¨Ø¶Ø§Ø¹Ø©: {user_data[user_id]['item']}\nØ§Ù„ÙˆØµÙ ÙˆØ§Ù„Ø´Ø±ÙˆØ·: {user_data[user_id]['details']}\nØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: {user_data[user_id]['phone']}"
            send_to_admin(info)
            user_states[user_id] = None
            user_data[user_id] = {}
            return jsonify({"reply": "ØªÙ… Ø­ÙØ¸ Ø·Ù„Ø¨Ùƒ ÙˆØ§Ø±Ø³Ø§Ù„Ù‡ Ù„Ù„Ù…Ø´Ø±Ù Ù„Ø¥Ø¶Ø§ÙØªÙ‡ ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª Ù…Ù…ÙƒÙ†ØŒ Ø´ÙƒØ±Ø§ Ù„Ùƒ ğŸ™"})

    return jsonify({"reply": "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©."}), 200

if __name__ == "__main__":
    app.run(port=5000)
